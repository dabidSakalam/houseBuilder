<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Project Inquiries</title>
  <link rel="stylesheet" href="./styles/inquiries.css">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="./scripts/checkAdminLogin.js"></script>
</head>

<body>
  <header class="admin-header">
    <h1>Inquiries</h1>

    <!-- Search beside title -->
    <section class="inquiry-controls">
      <input type="text" id="searchInquiry" placeholder="Search by client or project...">
    </section>

 <nav>
    <a href="dashboard.html">Statistics</a>
    <a href="models.html">Models</a>
    <a href="cityRates.html">City</a>
    <a href="features.html">Features</a>
    <a href="inquiries.html" class="active">Inquiries</a>
     <button id="logoutBtn" class="btn-logout" type="button">Logout</button>
  </nav>
  </header>

  <main class="admin-main">
    <!-- Filters bar: status & sort -->
    <section class="inquiry-filters-bar">
      <div class="filter-group">
        <label for="statusFilter">Status:</label>
        <select id="statusFilter">
          <option value="all">All</option>
          <option value="pending">Pending</option>
          <option value="accepted">Accepted</option>
          <option value="completed">Completed</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="sortFilter">Sort by:</label>
        <select id="sortFilter">
          <option value="date-desc">Date (Newest first)</option>
          <option value="date-asc">Date (Oldest first)</option>
          <option value="name-asc">Client Name (Aâ€“Z)</option>
          <option value="name-desc">Client Name (Zâ€“A)</option>
        </select>
      </div>
    </section>

    <section class="inquiry-table-section">
      <table class="inquiry-table">
        <thead>
          <tr>
            <th>Client</th>
            <th>Bedrooms</th>
            <th>Bathrooms</th>
            <th>Floors</th>
            <th>Style</th>
            <th>Unit Size (sqm)</th>
            <th>Features</th>
            <th>City</th>
            <th>Status</th>
            <th>Created Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="inquiryTableBody">
          <!-- Populated by JS -->
        </tbody>
      </table>
    </section>
  </main>

  <!-- ===== CHAT MODAL ===== -->
<div id="chatModal" class="modal">
  <div class="modal-content">
    <div class="chat-header">
      <div class="chat-header-text">
        <h2 id="chatTitle">Messages</h2>
        <p id="chatTargetMeta" class="chat-meta"></p>
      </div>
      <button class="close-btn" type="button">&times;</button>
    </div>

    <div id="chatContainer" class="chat-container"></div>
    <div id="imagePreview" style="display: none;" class="image-preview">
      <img id="previewImg" src="" alt="Preview">
      <div class="remove-preview" id="removePreview">Ã—</div>
    </div>
    <div class="chat-input">
      <div class="file-input-wrapper">
        <input type="file" id="imgInput" accept="image/*">
        <label for="imgInput" class="file-label" id="fileLabel">ğŸ“</label>
      </div>
      <input type="text" id="msgInput" placeholder="Type a message...">
      <button id="sendMsgBtn">Send</button>
    </div>
  </div>
</div>



  <!-- Lightbox for Chat Images -->
  <div id="lightbox" class="lightbox">
    <span class="lightbox-close">&times;</span>
    <img id="lightboxImg" src="" alt="Full Image">
  </div>

  <!-- ===== DETAILS MODAL (EMBEDDED) ===== -->
  <div class="details-modal-overlay" id="detailsModal">
    <div class="details-modal">
      <div class="details-header">
        <h2>Inquiry Details</h2>
        <button class="close-details" id="closeDetails">&times;</button>
      </div>
      <div class="details-body" id="detailsContent">
        <div style="text-align: center; padding: 60px;">
          <p>Loading details...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Lightbox for Details Modal -->
  <div class="image-lightbox" id="imageLightbox">
    <button class="lightbox-close-btn" id="closeLightboxBtn">&times;</button>
    <img id="lightboxImage" src="" alt="Full size">
  </div>

  <!-- ğŸŒ™ Floating dark mode toggle -->
  <button
    id="theme-toggle"
    class="theme-toggle-fab"
    aria-label="Toggle dark mode"
    type="button"
  >
    ğŸŒ™
  </button>

  <!-- Details Modal Script -->
  <script>
    const detailsModal = document.getElementById('detailsModal');
    const closeDetailsBtn = document.getElementById('closeDetails');
    const detailsContent = document.getElementById('detailsContent');
    const imageLightbox = document.getElementById('imageLightbox');
    const lightboxImage = document.getElementById('lightboxImage');
    const closeLightboxBtn = document.getElementById('closeLightboxBtn');

    // Open Details Modal
    async function openDetailsModal(inquiryId) {
      detailsModal.classList.add('active');
      document.body.style.overflow = 'hidden';

      try {
        const token = localStorage.getItem('adminToken') || localStorage.getItem('token');
        const response = await fetch(`http://localhost:3000/api/v1/estimates/inquiries/${inquiryId}/details`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to fetch details');
        }

        const inquiry = await response.json();
        renderInquiryDetails(inquiry);

      } catch (error) {
        console.error('Error fetching inquiry details:', error);
        detailsContent.innerHTML = `
          <div style="text-align: center; padding: 60px; color: #ef4444;">
            <p style="font-size: 48px;">âš ï¸</p>
            <p style="font-size: 18px; font-weight: 600;">Failed to load details</p>
            <p style="color: #6b7280; margin-top: 10px;">Please try again</p>
          </div>
        `;
      }
    }

    // Render Inquiry Details
    function renderInquiryDetails(inquiry) {
      const hasMessage = inquiry.client_message && inquiry.client_message.trim();
      
      // Parse design_images if it's a string
      let designImages = [];
      if (inquiry.design_images) {
        try {
          designImages = typeof inquiry.design_images === 'string' 
            ? JSON.parse(inquiry.design_images) 
            : inquiry.design_images;
        } catch (e) {
          console.error('Error parsing design_images:', e);
          designImages = [];
        }
      }
      
      const hasImages = designImages && Array.isArray(designImages) && designImages.length > 0;

      detailsContent.innerHTML = `
        <div class="detail-section">
          <div class="section-title">
            <span>ğŸ‘¤</span>
            Client Information
          </div>
          <div class="user-info-card">
            <div class="info-item">
              <span class="info-label">Name</span>
              <span class="info-value">${inquiry.user_name || 'N/A'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Email</span>
              <span class="info-value">${inquiry.user_email || 'N/A'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Status</span>
              <span class="status-badge ${inquiry.status}">${inquiry.status}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Inquiry Date</span>
              <span class="info-value">${new Date(inquiry.created_at).toLocaleDateString()}</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <div class="section-title">
            <span>ğŸ› </span>
            Property Specifications
          </div>
          <div class="property-grid">
            <div class="property-item">
              <div class="property-icon">ğŸ›ï¸</div>
              <div>Bedrooms</div>
              <div class="property-value">${inquiry.bedrooms}</div>
            </div>
            <div class="property-item">
              <div class="property-icon">ğŸš¿</div>
              <div>Bathrooms</div>
              <div class="property-value">${inquiry.bathrooms}</div>
            </div>
            <div class="property-item">
              <div class="property-icon">ğŸ¢</div>
              <div>Floors</div>
              <div class="property-value">${inquiry.floors}</div>
            </div>
            <div class="property-item">
              <div class="property-icon">ğŸ“</div>
              <div>Unit Size</div>
              <div class="property-value">${inquiry.unit_size} mÂ²</div>
            </div>
            <div class="property-item">
              <div class="property-icon">ğŸ¨</div>
              <div>Style</div>
              <div class="property-value">${inquiry.style}</div>
            </div>
            <div class="property-item">
              <div class="property-icon">ğŸ“</div>
              <div>City</div>
              <div class="property-value">${inquiry.city}</div>
            </div>
          </div>
        </div>

        ${inquiry.feature_names && inquiry.feature_names.length > 0 ? `
        <div class="detail-section">
          <div class="section-title">
            <span>âœ¨</span>
            Additional Features
          </div>
          <div class="features-list">
            ${inquiry.feature_names.map(feature => `
              <span class="feature-tag">${feature}</span>
            `).join('')}
          </div>
        </div>
        ` : ''}

        <div class="detail-section">
          <div class="section-title">
            <span>ğŸ’¬</span>
            Client Message
          </div>
          <div class="message-box ${!hasMessage ? 'empty' : ''}">
            ${hasMessage ? inquiry.client_message : 'No message provided'}
          </div>
        </div>

        <div class="detail-section">
          <div class="section-title">
            <span>ğŸ“‘</span>
            Design References
          </div>
          ${hasImages ? `
            <div class="images-grid">
              ${designImages.map(imagePath => {
                const fullPath = imagePath.startsWith('http') 
                  ? imagePath 
                  : `http://localhost:3000${imagePath}`;
                return `
                  <div class="image-item" onclick="openImageLightbox('${fullPath}')">
                    <img src="${fullPath}" alt="Design reference" onerror="this.parentElement.innerHTML='<div style=\\'padding:20px;text-align:center;\\'>âŒ Image failed to load</div>'">
                    <div class="zoom-icon">ğŸ”</div>
                  </div>
                `;
              }).join('')}
            </div>
          ` : `
            <div class="no-images">
              ğŸ“· No design images uploaded
            </div>
          `}
        </div>
      `;
    }

    // Close Details Modal
    function closeDetailsModal() {
      detailsModal.classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    closeDetailsBtn.addEventListener('click', closeDetailsModal);
    detailsModal.addEventListener('click', (e) => {
      if (e.target === detailsModal) closeDetailsModal();
    });

    // Image Lightbox for details
    function openImageLightbox(imageSrc) {
      lightboxImage.src = imageSrc;
      imageLightbox.classList.add('active');
    }

    function closeImageLightbox() {
      imageLightbox.classList.remove('active');
    }

    closeLightboxBtn.addEventListener('click', closeImageLightbox);
    imageLightbox.addEventListener('click', (e) => {
      if (e.target === imageLightbox) closeImageLightbox();
    });

    // Export function
    window.openDetailsModal = openDetailsModal;
  </script>

  <script src="./scripts/inquiries.js"></script>

  <!-- ğŸŒ™ Theme toggle logic -->
  <script>
    const root = document.documentElement;
    const themeToggleBtn = document.getElementById('theme-toggle');

    function applyTheme(theme) {
      if (theme === 'dark') {
        root.classList.add('dark');
        themeToggleBtn.textContent = 'â˜€ï¸';
      } else {
        root.classList.remove('dark');
        themeToggleBtn.textContent = 'ğŸŒ™';
      }
    }

    const savedTheme = localStorage.getItem('admin-theme');
    applyTheme(savedTheme === 'dark' ? 'dark' : 'light');

    themeToggleBtn.addEventListener('click', () => {
      const newTheme = root.classList.contains('dark') ? 'light' : 'dark';
      applyTheme(newTheme);
      localStorage.setItem('admin-theme', newTheme);
    });
  </script>
</body>

</html>
