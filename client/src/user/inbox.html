<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Inbox</title>

  <!-- Font Awesome for back icon -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <link rel="stylesheet" href="./styles/inbox.css">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>

<body>
  <!-- NAVBAR (same format as profile page) -->
  <header class="navbar">
    <!-- Left: back button + brand -->
    <div class="nav-left">
      <button
        class="back-button"
        type="button"
        aria-label="Back to Home"
        onclick="window.location.href='home.html'"
      >
        <i class="fa-solid fa-arrow-left"></i>
      </button>

      <a href="./home.html" class="brand">
        <div class="brand-logo-box">HB</div>
        <div class="brand-text">
          <span class="brand-title">HouseBuilder</span>
          <span class="brand-tagline">Your Partner in Residential Construction</span>
        </div>
      </a>
    </div>

    <!-- Center title -->
    <div class="nav-center">
      <h1 class="nav-page-title">Inbox</h1>
    </div>

    <!-- Right: user icon dropdown (NO inbox item here) -->
    <nav class="nav-right">
      <div class="user-menu" id="userMenu">
        <button class="user-icon" id="userIcon" aria-label="Open account menu">
          ðŸ‘¤
        </button>

        <div class="user-dropdown" id="userDropdown">
          <button
            class="dropdown-item"
            onclick="window.location.href='profile.html'"
          >
            My Profile
          </button>
          <button class="dropdown-item dropdown-logout" id="logoutBtn">
            Logout
          </button>
        </div>
      </div>
    </nav>
  </header>

  <!-- MAIN CONTENT -->
  <main class="inbox-main">
    <table id="inquiryTable">
      <thead>
        <tr>
          <th>Inquiry ID</th>
          <th>Message Preview</th>
          <th>Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="inquiryTableBody"></tbody>
    </table>
  </main>

  <!-- CHAT MODAL -->
  <div id="chatModal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <div id="chatContainer"></div>

      <div id="imagePreview" style="display: none;" class="image-preview">
        <img id="previewImg" src="" alt="Preview">
        <div class="remove-preview" id="removePreview">Ã—</div>
      </div>

      <div class="input-area">
        <div class="file-input-wrapper">
          <input type="file" id="imgInput" accept="image/*">
          <label for="imgInput" class="file-label" id="fileLabel">ðŸ“Ž</label>
        </div>
        <input type="text" id="msgInput" placeholder="Type your message..." />
        <button class="send-btn" id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <!-- Lightbox for Full Image View -->
  <div id="lightbox" class="lightbox">
    <span class="lightbox-close">&times;</span>
    <img id="lightboxImg" src="" alt="Full Image">
  </div>

  <!-- Floating Dark-Mode Toggle -->
  <button
    class="theme-toggle"
    id="themeToggleBtn"
    aria-label="Toggle dark mode"
  >
    <span class="theme-toggle-icon" id="themeToggleIcon">ðŸŒ™</span>
  </button>
  <footer class="profile-footer">
  <div class="footer-inner">
    <p>Â© 2025 HouseBuilder. All rights reserved.</p>
    <div class="footer-socials">
      <a
        href="https://facebook.com/khiaramarie.delmundo.18"
        target="_blank"
        aria-label="HouseBuilder on Facebook"
      >
        <i class="fab fa-facebook-f"></i>
      </a>
      <a
        href="https://instagram.com/_rentfl"
        target="_blank"
        aria-label="HouseBuilder on Instagram"
      >
        <i class="fab fa-instagram"></i>
      </a>
      <a
        href="https://x.com/yourpage"
        target="_blank"
        aria-label="HouseBuilder on X (Twitter)"
      >
        <i class="fab fa-x-twitter"></i>
      </a>
    </div>
  </div>
</footer>

  <script>
    const tableBody = document.getElementById('inquiryTableBody');
    const token = localStorage.getItem('authToken');

    const modal = document.getElementById('chatModal');
    const chatContainer = document.getElementById('chatContainer');
    const msgInput = document.getElementById('msgInput');
    const imgInput = document.getElementById('imgInput');
    const sendBtn = document.getElementById('sendBtn');
    const fileLabel = document.getElementById('fileLabel');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const removePreview = document.getElementById('removePreview');

    let currentInquiryId = null;
    let selectedFile = null;
    let socket = null;

    // ========================
    // SOCKET.IO
    // ========================
    function initSocket() {
      socket = io('http://localhost:3000');

      socket.on('connect', () => {
        console.log('Connected to server');
      });

      socket.on('new-message', (message) => {
        console.log('New message received:', message);
        if (message.inquiryId == currentInquiryId && modal.style.display === 'block') {
          appendMessage(message);
        }

        // Also refresh preview for that inquiry
        if (message.inquiryId) {
          updateSinglePreview(message.inquiryId);
        }
      });

      socket.on('disconnect', () => {
        console.log('Disconnected from server');
      });
    }

    function joinInquiryRoom(inquiryId) {
      if (socket && socket.connected) {
        socket.emit('join-inquiry', inquiryId);
      }
    }

    function leaveInquiryRoom(inquiryId) {
      if (socket && socket.connected) {
        socket.emit('leave-inquiry', inquiryId);
      }
    }

    // ========================
    // MODAL CONTROLS
    // ========================
    modal.querySelector('.close-btn').addEventListener('click', () => {
      if (currentInquiryId) leaveInquiryRoom(currentInquiryId);
      modal.style.display = 'none';
      clearImagePreview();
    });

    window.addEventListener('click', e => {
      if (e.target === modal) {
        if (currentInquiryId) leaveInquiryRoom(currentInquiryId);
        modal.style.display = 'none';
        clearImagePreview();
      }
    });

    // ========================
    // IMAGE PREVIEW
    // ========================
    imgInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target.result;
          imagePreview.style.display = 'block';
          fileLabel.classList.add('has-file');
          fileLabel.textContent = 'âœ“';
        };
        reader.readAsDataURL(file);
      }
    });

    removePreview.addEventListener('click', clearImagePreview);

    function clearImagePreview() {
      selectedFile = null;
      imgInput.value = '';
      imagePreview.style.display = 'none';
      previewImg.src = '';
      fileLabel.classList.remove('has-file');
      fileLabel.textContent = 'ðŸ“Ž';
    }

    // ========================
    // INBOX FETCH
    // ========================
    async function fetchInquiries() {
      if (!token) {
        alert('Please login first.');
        return;
      }
      try {
        const res = await fetch('http://localhost:3000/api/v1/users/inbox', {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (res.status === 401) {
          alert('Unauthorized. Please login again.');
          return;
        }

        const inquiries = await res.json();
        if (!Array.isArray(inquiries)) {
          console.error('Invalid data:', inquiries);
          return;
        }
        renderTable(inquiries);
      } catch (err) {
        console.error(err);
        alert('Failed to fetch inquiries');
      }
    }

    // Build table rows, then load previews using /messages/:inquiryId
    function renderTable(inquiries) {
      tableBody.innerHTML = '';

      inquiries.forEach(inq => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${inq.inquiry_id}</td>
          <td class="preview-cell" data-inquiry-id="${inq.inquiry_id}">Loading...</td>
          <td>${inq.created_at ? new Date(inq.created_at).toLocaleDateString() : ''}</td>
          <td><button class="reply-btn" data-id="${inq.inquiry_id}">View</button></td>
        `;
        tableBody.appendChild(row);
      });

      attachRowActions();
      loadPreviews(inquiries);
    }

    async function loadPreviews(inquiries) {
      for (const inq of inquiries) {
        await updateSinglePreview(inq.inquiry_id);
      }
    }

    async function updateSinglePreview(inquiryId) {
      const cell = document.querySelector(
        `.preview-cell[data-inquiry-id="${inquiryId}"]`
      );
      if (!cell) return;

      cell.textContent = 'Loading...';

      try {
        const res = await fetch(
          `http://localhost:3000/api/v1/users/messages/${inquiryId}`,
          { headers: { Authorization: `Bearer ${token}` } }
        );

        if (!res.ok) {
          throw new Error('Status ' + res.status);
        }

        const messages = await res.json();

        let previewText = 'No messages yet';
        if (Array.isArray(messages) && messages.length > 0) {
          const last = messages[messages.length - 1];

          const text =
            (last.message && String(last.message).trim()) ||
            (last.text && String(last.text).trim()) ||
            (last.content && String(last.content).trim()) ||
            '';

          if (text) {
            previewText = text;
          } else if (last.imageUrl || last.image || last.image_url) {
            previewText = '[Image attachment]';
          } else {
            previewText = '(No text content)';
          }
        }

        const short =
          previewText.length > 50
            ? previewText.substring(0, 50) + '...'
            : previewText;

        cell.textContent = short;
      } catch (err) {
        console.error('Preview load failed for inquiry', inquiryId, err);
        cell.textContent = '(Preview unavailable)';
      }
    }

    // ========================
    // ROW ACTIONS
    // ========================
    function attachRowActions() {
      document.querySelectorAll('.reply-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          if (currentInquiryId) leaveInquiryRoom(currentInquiryId);
          currentInquiryId = e.target.dataset.id;
          modal.style.display = 'block';
          fetchMessages(currentInquiryId);
          joinInquiryRoom(currentInquiryId);
        });
      });
    }

    // ========================
    // CHAT MESSAGES
    // ========================
    async function fetchMessages(inquiryId) {
      chatContainer.innerHTML = '<div class="loading">Loading messages...</div>';
      try {
        const res = await fetch(
          `http://localhost:3000/api/v1/users/messages/${inquiryId}`,
          { headers: { Authorization: `Bearer ${token}` } }
        );
        const messages = await res.json();
        renderMessages(messages);
      } catch (err) {
        console.error(err);
        chatContainer.innerHTML =
          '<div class="loading">Failed to load messages</div>';
      }
    }

    function renderMessages(messages) {
      chatContainer.innerHTML = '';
      messages.forEach(m => {
        appendMessage(m);
      });
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function appendMessage(m) {
      const div = document.createElement('div');
      div.classList.add('message', m.senderType === 'admin' ? 'admin' : 'user');
      div.setAttribute('data-message-id', m.messageId);
      div.innerHTML = `
        <strong>${m.senderName}</strong>
        <span class="msg-date">${new Date(m.createdAt).toLocaleString()}</span>
        ${m.message ? `<p>${m.message}</p>` : ''}
        ${m.imageUrl ? `<img src="${m.imageUrl}" class="chat-image" alt="Sent image">` : ''}
      `;

      const existing = chatContainer.querySelector(
        `[data-message-id="${m.messageId}"]`
      );
      if (!existing) {
        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    }

    // ========================
    // SEND MESSAGE / IMAGE
    // ========================
    sendBtn.addEventListener('click', sendMessage);

    async function sendMessage() {
      const msg = msgInput.value.trim();

      if (!msg && !selectedFile) return;
      if (!currentInquiryId) return;

      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';

      try {
        if (selectedFile) {
          const formData = new FormData();
          formData.append('image', selectedFile);
          formData.append('inquiryId', currentInquiryId);
          if (msg) formData.append('message', msg);

          const res = await fetch(
            `http://localhost:3000/api/v1/users/messages/send-image`,
            {
              method: 'POST',
              headers: { Authorization: `Bearer ${token}` },
              body: formData
            }
          );

          if (!res.ok) {
            const errorText = await res.text();
            throw new Error(
              `Image upload failed: ${res.status} - ${errorText}`
            );
          }

          await res.json();
          clearImagePreview();
        } else if (msg) {
          const res = await fetch(
            `http://localhost:3000/api/v1/users/messages/send`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${token}`
              },
              body: JSON.stringify({
                inquiryId: currentInquiryId,
                message: msg
              })
            }
          );

          if (!res.ok) {
            const errorText = await res.text();
            throw new Error(`Failed to send message: ${res.status} - ${errorText}`);
          }
        }

        msgInput.value = '';
        fetchMessages(currentInquiryId);
        updateSinglePreview(currentInquiryId);
      } catch (err) {
        console.error('Send error:', err);
        alert('Failed to send: ' + err.message);
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
      }
    }

    // ========================
    // IMAGE LIGHTBOX
    // ========================
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightboxImg');
    const lightboxClose = document.querySelector('.lightbox-close');

    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('chat-image')) {
        lightboxImg.src = e.target.src;
        lightbox.classList.add('active');
      }
    });

    if (lightboxClose) {
      lightboxClose.addEventListener('click', () => {
        lightbox.classList.remove('active');
      });
    }

    if (lightbox) {
      lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox) {
          lightbox.classList.remove('active');
        }
      });
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && lightbox && lightbox.classList.contains('active')) {
        lightbox.classList.remove('active');
      }
    });

    // ========================
    // USER MENU DROPDOWN + LOGOUT
    // ========================
    const userIcon = document.getElementById('userIcon');
    const userDropdown = document.getElementById('userDropdown');
    const logoutBtn = document.getElementById('logoutBtn');

    if (userIcon && userDropdown) {
      userIcon.addEventListener('click', () => {
        userDropdown.classList.toggle('show');
      });

      document.addEventListener('click', (e) => {
        if (!userDropdown.contains(e.target) && !userIcon.contains(e.target)) {
          userDropdown.classList.remove('show');
        }
      });
    }

    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('authToken');
        window.location.href = 'login.html';
      });
    }

    // ========================
    // DARK MODE TOGGLE
    // ========================
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const themeToggleIcon = document.getElementById('themeToggleIcon');

    function applyTheme(theme) {
      if (theme === 'dark') {
        document.body.classList.add('dark-mode');
        themeToggleIcon.textContent = 'â˜€ï¸';
      } else {
        document.body.classList.remove('dark-mode');
        themeToggleIcon.textContent = 'ðŸŒ™';
      }
    }

    const savedTheme = localStorage.getItem('hb-theme') || 'light';
    applyTheme(savedTheme);

    if (themeToggleBtn) {
      themeToggleBtn.addEventListener('click', () => {
        const newTheme = document.body.classList.contains('dark-mode')
          ? 'light'
          : 'dark';
        applyTheme(newTheme);
        localStorage.setItem('hb-theme', newTheme);
      });
    }

    // ========================
    // INITIAL LOAD
    // ========================
    fetchInquiries();
    initSocket();
  </script>


</body>

</html>
