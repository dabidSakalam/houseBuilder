<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Inbox</title>
  <link rel="stylesheet" href="./styles/inbox.css">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>

<body>
  <h1>Inbox</h1>

  <a href="./home.html" class="back-btn">‚Üê BACK</a>

  <table id="inquiryTable">
    <thead>
      <tr>
        <th>Inquiry ID</th>
        <th>Message Preview</th>
        <th>Date</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="inquiryTableBody"></tbody>
  </table>

  <div id="chatModal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <div id="chatContainer"></div>
      <div id="imagePreview" style="display: none;" class="image-preview">
        <img id="previewImg" src="" alt="Preview">
        <div class="remove-preview" id="removePreview">√ó</div>
      </div>
      <div class="input-area">
        <div class="file-input-wrapper">
          <input type="file" id="imgInput" accept="image/*">
          <label for="imgInput" class="file-label" id="fileLabel">üìé</label>
        </div>
        <input type="text" id="msgInput" placeholder="Type your message..." />
        <button class="send-btn" id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <!-- Lightbox for Full Image View -->
  <div id="lightbox" class="lightbox">
    <span class="lightbox-close">&times;</span>
    <img id="lightboxImg" src="" alt="Full Image">
  </div>

  <script>
    const tableBody = document.getElementById('inquiryTableBody');
    const token = localStorage.getItem('authToken');

    const modal = document.getElementById('chatModal');
    const chatContainer = document.getElementById('chatContainer');
    const msgInput = document.getElementById('msgInput');
    const imgInput = document.getElementById('imgInput');
    const sendBtn = document.getElementById('sendBtn');
    const fileLabel = document.getElementById('fileLabel');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const removePreview = document.getElementById('removePreview');

    let currentInquiryId = null;
    let selectedFile = null;
    let socket = null;

    // Initialize Socket.io
    function initSocket() {
      socket = io('http://localhost:3000');

      socket.on('connect', () => {
        console.log('Connected to server');
      });

      socket.on('new-message', (message) => {
        console.log('New message received:', message);
        if (message.inquiryId == currentInquiryId && modal.style.display === 'block') {
          appendMessage(message);
        }
      });

      socket.on('disconnect', () => {
        console.log('Disconnected from server');
      });
    }

    // Join inquiry room
    function joinInquiryRoom(inquiryId) {
      if (socket && socket.connected) {
        socket.emit('join-inquiry', inquiryId);
      }
    }

    // Leave inquiry room
    function leaveInquiryRoom(inquiryId) {
      if (socket && socket.connected) {
        socket.emit('leave-inquiry', inquiryId);
      }
    }

    // Modal controls
    modal.querySelector('.close-btn').addEventListener('click', () => {
      if (currentInquiryId) leaveInquiryRoom(currentInquiryId);
      modal.style.display = 'none';
      clearImagePreview();
    });

    window.addEventListener('click', e => {
      if (e.target === modal) {
        if (currentInquiryId) leaveInquiryRoom(currentInquiryId);
        modal.style.display = 'none';
        clearImagePreview();
      }
    });

    // Image preview handling
    imgInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target.result;
          imagePreview.style.display = 'block';
          fileLabel.classList.add('has-file');
          fileLabel.textContent = '‚úì';
        };
        reader.readAsDataURL(file);
      }
    });

    removePreview.addEventListener('click', clearImagePreview);

    function clearImagePreview() {
      selectedFile = null;
      imgInput.value = '';
      imagePreview.style.display = 'none';
      previewImg.src = '';
      fileLabel.classList.remove('has-file');
      fileLabel.textContent = 'üìé';
    }

    // Enter key to send
    msgInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // ===== FETCH USER INBOX =====
    async function fetchInquiries() {
      if (!token) {
        alert('Please login first.');
        return;
      }
      try {
        const res = await fetch('http://localhost:3000/api/v1/users/inbox', {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (res.status === 401) {
          alert('Unauthorized. Please login again.');
          return;
        }

        const inquiries = await res.json();
        if (!Array.isArray(inquiries)) {
          console.error('Invalid data:', inquiries);
          return;
        }
        renderTable(inquiries);
      } catch (err) {
        console.error(err);
        alert('Failed to fetch inquiries');
      }
    }

    // ===== RENDER TABLE =====
    function renderTable(inquiries) {
      tableBody.innerHTML = '';
      inquiries.forEach(inq => {
        const lastMessage = inq.messages?.length ? inq.messages[inq.messages.length - 1].message : '';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${inq.inquiry_id}</td>
          <td>${lastMessage.substring(0, 50)}${lastMessage.length > 50 ? '...' : ''}</td>
          <td>${inq.created_at ? new Date(inq.created_at).toLocaleDateString() : ''}</td>
          <td><button class="reply-btn" data-id="${inq.inquiry_id}">View</button></td>
        `;
        tableBody.appendChild(row);
      });
      attachRowActions();
    }

    function attachRowActions() {
      document.querySelectorAll('.reply-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          if (currentInquiryId) leaveInquiryRoom(currentInquiryId);
          currentInquiryId = e.target.dataset.id;
          modal.style.display = 'block';
          fetchMessages(currentInquiryId);
          joinInquiryRoom(currentInquiryId);
        });
      });
    }

    // ===== FETCH MESSAGES =====
    async function fetchMessages(inquiryId) {
      chatContainer.innerHTML = '<div class="loading">Loading messages...</div>';
      try {
        const res = await fetch(`http://localhost:3000/api/v1/users/messages/${inquiryId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const messages = await res.json();
        renderMessages(messages);
      } catch (err) {
        console.error(err);
        chatContainer.innerHTML = '<div class="loading">Failed to load messages</div>';
      }
    }

    function renderMessages(messages) {
      chatContainer.innerHTML = '';
      messages.forEach(m => {
        appendMessage(m);
      });
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function appendMessage(m) {
      const div = document.createElement('div');
      div.classList.add('message', m.senderType === 'admin' ? 'admin' : 'user');
      div.setAttribute('data-message-id', m.messageId);
      div.innerHTML = `
        <strong>${m.senderName}</strong>
        <span class="msg-date">${new Date(m.createdAt).toLocaleString()}</span>
        ${m.message ? `<p>${m.message}</p>` : ''}
        ${m.imageUrl ? `<img src="${m.imageUrl}" class="chat-image" alt="Sent image">` : ''}
      `;

      // Check if message already exists
      const existing = chatContainer.querySelector(`[data-message-id="${m.messageId}"]`);
      if (!existing) {
        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    }

    // ===== SEND MESSAGE OR IMAGE =====
    sendBtn.addEventListener('click', sendMessage);

    async function sendMessage() {
      const msg = msgInput.value.trim();

      if (!msg && !selectedFile) return;
      if (!currentInquiryId) return;

      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';

      try {
        if (selectedFile) {
          const formData = new FormData();
          formData.append('image', selectedFile);
          formData.append('inquiryId', currentInquiryId);
          if (msg) formData.append('message', msg);

          console.log('Sending image...', {
            fileName: selectedFile.name,
            fileSize: selectedFile.size,
            fileType: selectedFile.type,
            inquiryId: currentInquiryId
          });

          const res = await fetch(`http://localhost:3000/api/v1/users/messages/send-image`, {
            method: 'POST',
            headers: { Authorization: `Bearer ${token}` },
            body: formData
          });

          console.log('Response status:', res.status);

          if (!res.ok) {
            const errorText = await res.text();
            console.error('Server response:', errorText);
            throw new Error(`Image upload failed: ${res.status} - ${errorText}`);
          }

          const result = await res.json();
          console.log('Upload successful:', result);

          clearImagePreview();
        } else if (msg) {
          const res = await fetch(`http://localhost:3000/api/v1/users/messages/send`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`
            },
            body: JSON.stringify({ inquiryId: currentInquiryId, message: msg })
          });

          if (!res.ok) {
            const errorText = await res.text();
            console.error('Server response:', errorText);
            throw new Error(`Failed to send message: ${res.status}`);
          }
        }

        msgInput.value = '';
        fetchMessages(currentInquiryId);
      } catch (err) {
        console.error('Send error:', err);
        alert('Failed to send: ' + err.message);
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
      }
    }

    // ===== IMAGE LIGHTBOX =====
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightboxImg');
    const lightboxClose = document.querySelector('.lightbox-close');

    // Open lightbox when image is clicked
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('chat-image')) {
        lightboxImg.src = e.target.src;
        lightbox.classList.add('active');
      }
    });

    // Close lightbox
    if (lightboxClose) {
      lightboxClose.addEventListener('click', () => {
        lightbox.classList.remove('active');
      });
    }

    if (lightbox) {
      lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox) {
          lightbox.classList.remove('active');
        }
      });
    }

    // Close with ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && lightbox && lightbox.classList.contains('active')) {
        lightbox.classList.remove('active');
      }
    });

    // Initial load
    fetchInquiries();
    initSocket();
  </script>
</body>

</html>